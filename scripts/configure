#!/bin/bash

# Copyright (C) 2015 Yiqun Zhang <zhangyiqun9164@gmail.com>
# All Rights Reserved.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

if [ $# -ne 1 ]; then
  echo "Usage: configure [node count]"
  echo "Example: configure 10"
  exit
fi

ip=`hostname --ip-address`
echo "The IP address of this server is $ip."
former=`echo $ip | sed "s/\(^.*\.\).*$/\1/g"`
latter=`echo $ip | sed "s/^.*\.\(.*$\)/\1/g"`
for i in `seq 1 1 $1`; do
  printf "%s%d scidb%03d\n" $former `expr $latter + $i - 1` $i | sudo tee -a /etc/hosts
done
sudo vim /etc/hosts

dbname=`printf "n%03di02" $1`
echo -e "\E[0;32mPlease wait while we are working on each server to:"
echo -e "\t* Enable ssh connection for root user."
echo -e "\t* Distribute the new hosts file.\E[0m"
hostlist=""
for id in `seq 1 1 $1`; do
  host=`printf "scidb%03d" $id`
  hostlist="$hostlist $host"
  ssh -o StrictHostKeyChecking=no scidb@$host "sudo cp ~/.ssh/authorized_keys /root/.ssh/authorized_keys" > /dev/null 2>&1 &
  ssh -o StrictHostKeyChecking=no scidb@$host "sudo scp -o StrictHostKeyChecking=no scidb@${ip}:/etc/hosts /etc/hosts" > /dev/null 2>&1 &
done
for job in `jobs -p`; do
    wait $job
done

echo -e "\E[0;32mPreparing SciDB server...\E[0m"
echo "scidb" | $SCIDB_SOURCE_PATH/deployment/deploy.sh scidb_prepare scidb "" $dbname $dbname $dbname /home/scidb/scidbdata/$dbname 2 default 1 $hostlist
scidb.py startall $dbname

echo -e "\E[0;32mUpdating SciDB user defined operators.\E[0m"
cd /home/scidb/gamma-scidb
git pull

echo -e "\E[0;32mCompiling and installing SciDB user defined operators.\E[0m"
dirs=("/home/scidb/gamma-scidb/Load2D" "/home/scidb/gamma-scidb/DenseGamma")
for dir in ${dirs[@]}; do
  cd $dir
  make clean
  make
  distribute $1
  make install
done

echo -e "\n\E[0;32mConfiguration complete.\E[0m"
